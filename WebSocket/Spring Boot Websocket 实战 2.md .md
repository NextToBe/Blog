#  Sping Boot WebSocket å®æˆ˜  2



ç»§ç»­ä¸Šæ¬¡çš„å†…å®¹ï¼Œ ä¸Šæ¬¡æˆ‘ä»¬åªæ˜¯ç®€å•çš„å®ç°äº†æœ€åŸºæœ¬çš„ç‚¹å¯¹ç‚¹é€šä¿¡ï¼Œä½†æ˜¯å®é™…ä¸Šçš„ç©å…·çº§åº”ç”¨ä¹Ÿè¦æ¯”è¿™ä¸ªå¤æ‚ã€‚æœ¬æ–‡ç»§ç»­æ·±å…¥å®é™…ç”Ÿäº§ä¸­æ‰€åº”ç”¨çš„ *Spring WebSocket*



è€ƒè™‘å¦‚ä¸‹æƒ…å†µï¼š

![](resources/1.jpg)

å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬çš„åº”ç”¨éƒ¨ç½²åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šï¼Œ ç°åœ¨æœ‰ä¸¤ä¸ªç”¨æˆ·åŒæ—¶å‘èµ·äº† *websocket* è¿æ¥ï¼Œç»è¿‡ *Nginx* è½¬å‘ä¹‹å ***user1*** ä¸ ***server2*** å»ºç«‹äº†è¿æ¥ï¼Œè€Œ ***user2*** ä¸ ***Server1*** å»ºç«‹äº†è¿æ¥ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œ ***user1*** å‘ ***user2*** å‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯ï¼Œå› ä¸º ***server2*** å¹¶æ²¡æœ‰ ***user2*** çš„è¿æ¥ï¼Œæ‰€ä»¥æ— æ³•å°†æ¶ˆæ¯æ¨é€ç»™ ***user2***ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ•´ä¸ªåº”ç”¨éƒ½é™·å…¥äº†æ— æ³•æ­£å¸¸å·¥ä½œçš„çŠ¶æ€ã€‚



ä»å•æœºæ°æ€ç»´å‘åˆ†å¸ƒå¼æ€ç»´è½¬æ¢æ˜¯ä¸€ä¸ªå¿…ç„¶è€Œé‡è¦çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¿…é¡»æ—¶åˆ»è€ƒè™‘å¦‚æœæˆ‘ä»¬çš„ç¨‹åºåœ¨å¤šå°æœºå™¨ä¸Šèƒ½å¦æ­£å¸¸çš„è¿è¡Œã€‚



æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦è®©æœåŠ¡å™¨ä¹‹é—´å¯ä»¥è¿›è¡Œé€šä¿¡ï¼Œä¸€èˆ¬æ¥è®²ï¼ŒæœåŠ¡å™¨ä¹‹é—´é€šä¿¡å°±æ˜¯å»ºç«‹ *tcp* è¿æ¥æ¥ä¼ è¾“æ•°æ®ï¼Œæ¯”å¦‚  *Hadoop* ä¸ *Spark* ï¼Œåœ¨ *Reduce* é˜¶æ®µéœ€è¦æŠŠè‡ªå·±çš„è®¡ç®—ç»“æœæ±‡é›†ï¼Œå¿…ç„¶éœ€è¦å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ç›¸äº’é€šä¿¡ï¼Œä½¿ç”¨ *Tcp é•¿è¿æ¥* å®‰å…¨åˆé«˜æ•ˆã€‚ ä½†æ˜¯è¿™ç§æ–¹å¼å®ç°èµ·æ¥ç›¸å¯¹éº»çƒ¦ï¼Œæˆ‘ä»¬å¤§å¯ä¸å¿…è¿™ä¹ˆåšï¼Œ è¿™é‡Œå¯ä»¥å€Ÿç”¨ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶æ¥å®Œæˆæ¶ˆæ¯çš„æ¥å—ä¸å‘é€å·¥ä½œï¼Œè‡ªç„¶è€Œç„¶çš„æˆ‘ä»¬å¯ä»¥è”æƒ³åˆ° ***æ¶ˆæ¯é˜Ÿåˆ—***ï¼Œæ¯”å¦‚ *RabbitMQ*ã€ *Kafka*ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹å¼ï¼Œä¸ç”¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œä½¿ç”¨ *Redis* çš„ *Pub/Sub* åŠŸèƒ½ã€‚æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š

![](resources/2.png)



åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ *redis* æ¥ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ©ç”¨å®ƒçš„ ***è®¢é˜…/å‘å¸ƒ*** åŠŸèƒ½æ¥å®ç°æˆ‘ä»¬åˆ†å¸ƒå¼çš„ç‚¹å¯¹ç‚¹é€šä¿¡ã€‚æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å°†æ”¶åˆ°çš„æ¶ˆæ¯å‘é€ç»™ *redis*ï¼Œå†ç”± *redis* å†³å®šéœ€è¦æ¨é€ç»™å“ªä¸€å°æœåŠ¡å™¨ã€‚é€šå¸¸æƒ…å†µï¼Œæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½ä¼šè®¢é˜… *redis* çš„è¯¥æ¡é€šé“ï¼Œæ‰€ä»¥ç›¸å½“äº*redis* åœ¨è¿™ä¸ªé€šé“ä¸Šè¿›è¡Œäº†ä¸€æ¬¡å¹¿æ’­ï¼Œæ‰€æœ‰æœåŠ¡å™¨éƒ½ä¼šå—åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œä¹‹åæ ¡éªŒæ¶ˆæ¯çš„æ¥å—è€…æ˜¯å¦ä¸è‡ªå·±å»ºç«‹äº†è¿æ¥ï¼Œå¦‚æœæ˜¯åˆ™å‘é€æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸¢å¼ƒè¯¥æ¶ˆæ¯ã€‚



ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“å®ç°ï¼šğŸ‘‡ï¼Œé¦–å…ˆéœ€è¦åœ¨ *Spring boot* åº”ç”¨å¯åŠ¨çš„é…ç½®ç±»ä¸­æ·»åŠ å¦‚ä¸‹ï¼š

```java

  @Bean
  RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory, MessageListenerAdapter adapter) {
    RedisMessageListenerContainer container = new RedisMessageListenerContainer();
    container.setConnectionFactory(connectionFactory);
    // websocket/message ä¸ºå‘å¸ƒè®¢é˜…çš„é€šé“
    container.addMessageListener(adapter, new ChannelTopic("websocket/message"));
    return container;
  }

  @Bean
  public MessageListenerAdapter listenerAdapter(MessageWebSocketService webSocketService) {
    // æ³¨æ„ï¼Œè¿™é‡Œ MessageWebSocketService å¿…é¡»è¢«æ³¨å…¥ï¼ŒæŒ‰ç…§ä¸Šå›çš„æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ª @Service
    // è¿™é‡Œé…ç½®äº†æ¥å—æ¶ˆæ¯çš„ç±»å’Œå…·ä½“æ–¹æ³•ã€‚æ¡†æ¶ä¼šä½¿ç”¨åå°„è·å–åˆ°æ–¹æ³•å¹¶ç”¨ä»£ç†å»è°ƒç”¨å®ƒã€‚
    MessageListenerAdapter adapter= new MessageListenerAdapter(webSocketService, "redisMessageReceiver");
    // è¿™é‡Œæ˜¯ä¸€ä¸ªå¤§å‘ï¼Œä½†æ˜¯åªæœ‰å¼€å‘ç¯å¢ƒä¼šé‡åˆ°ï¼Œåºåˆ—åŒ–çš„æ—¶å€™ä¼šé‡åˆ°ä¸¤ä¸ªä¸åŒç±»åŠ è½½å™¨åŠ è½½çš„çˆ¶å­ç±»(å…¶ä¸­ä¸€ä¸ªæ˜¯å¼€å‘ç¯å¢ƒç‹¬æœ‰çš„ï¼Œå½“ä½ ä¿®æ”¹å®Œæ–‡ä»¶å³å¯ç¼–è¯‘çƒ­å¯åŠ¨çš„ restartClassLoader)ï¼Œç„¶åä½¿ç”¨ isInstance ä¼šè¿”å› falseï¼Œè¿™æ¡æ¶ˆæ¯å˜ä¸ä¼šå¹¿æ’­ã€‚
    adapter.setSerializer(new JdkSerializationRedisSerializer(this.getClass().getClassLoader()));
    return adapter;
  }

```

è¦å‘å¸ƒæ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ä½çº§ *RedisConnection* æˆ–é«˜çº§çš„ *RedisTemplate* ã€‚è¿™ä¸¤ä¸ªå®ä½“æä¾›çš„ *publish* æ–¹æ³•æ¥å—ä½œä¸ºå‚æ•°éœ€è¦å‘é€çš„æ¶ˆæ¯ä»¥åŠç›®æ ‡é€šé“ã€‚ä½†æ˜¯ *RedisConnection* éœ€è¦åŸå§‹æ•°æ®ï¼ˆå­—èŠ‚æ•°ç»„ï¼‰æ—¶ï¼Œ*RedisTemplate* å…è®¸ä»»æ„å¯¹è±¡ä½œä¸ºæ¶ˆæ¯ä¼ å…¥ã€‚åŒæ—¶ï¼Œä½¿ç”¨ä½çº§çš„å‘å¸ƒ/è®¢é˜…æ—¶çº¿ç¨‹æ˜¯é˜»å¡çš„ï¼š

> Spring Data Redisä¸­çš„è®¢é˜…å‘½ä»¤æ˜¯é˜»å¡çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æ±‚è®¢é˜…çš„è¿æ¥ï¼Œå°†å¯¼è‡´å½“å‰çº¿ç¨‹é˜»å¡ï¼Œå› ä¸ºå®ƒä¼šå¼€	å§‹ç­‰å¾…æ¶ˆæ¯-åªæœ‰åœ¨è®¢è´­è¢«å–æ¶ˆçš„çº¿ç¨‹å°†è¢«é‡Šæ”¾ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹è°ƒç”¨ unsubscribe æˆ– pUnsubscribe åœ¨ä¸Šç›¸åŒçš„è¿æ¥ã€‚ç”±äºå…¶é˜»å¡æ€§è´¨ï¼Œä½çº§è®¢é˜…æ²¡æœ‰å¸å¼•åŠ›ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸ºæ¯ä¸ªå•ç‹¬çš„ç›‘å¬è€…è¿›è¡Œè¿æ¥å’Œçº¿ç¨‹ç®¡ç†ã€‚ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼ŒSpring Dataæä¾› RedisMessageListenerContainer äº†ä»£è¡¨ç”¨æˆ·çš„æ‰€æœ‰ç¹é‡å·¥ä½œ 

*RedisMessageListenerContainer* å……å½“æ¶ˆæ¯ç›‘å¬å™¨å®¹å™¨ï¼Œå®ƒç”¨äºæ¥æ”¶æ¥è‡ª *Redis* é€šé“çš„æ¶ˆæ¯ï¼Œå¹¶é©±åŠ¨ *MessageListener* ã€‚ä¾¦å¬å™¨å®¹å™¨è´Ÿè´£æ‰€æœ‰çš„æ¶ˆæ¯æ¥æ”¶çº¿ç¨‹ï¼Œå¹¶æ´¾å‘åˆ°ä¾¦å¬å™¨è¿›è¡Œå¤„ç†ã€‚



éšåæˆ‘ä»¬éœ€è¦å®šä¹‰å°çš„æ¥å—æ–¹æ³• ***redisMessageReceiver()***

```java
  public void redisMessageReceiver(PushMessageVO message) {
      // å‘é€æ¶ˆæ¯ï¼Œå…·ä½“ä»£ç è§ ç¬¬ä¸€å›
      sendMessageToUser(message.getUserLdap(), message.getMessageVOS());
      
  messageService.markAsSent(message.getMessageVOS().stream().map(MessageVO::getId).collect(Collectors.toList()));
    // æ ‡ä¸ºå·²ç»å‘é€
  }
```





è‡³æ­¤ï¼Œå¤§åŠŸå‘Šæˆã€‚

